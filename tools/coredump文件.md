## 1. coredump简介

### 1.1 什么是coredump？
通常情况下coredmp包含了程序运行时的内存，寄存器状态，堆栈指针，内存管理信息等。  
可以理解为把程序工作的当前状态存储成一个文件。许多程序和操作系统出错时会自动生成一个core文件。

### 1.2 如何使用coredump?
coredump可以用在很多场合，Linux,或者solaris系统在跑一些压力测试或者系统负载大的话，系统就hang住了或者干脆system panic.这时唯一能帮助你分析和解决问题的就是coredump了。
现在很多应该程序出错时也会出现coredump.

### 1.3 分析coredump的工具
现在大部分类unix操作系统都提供了分析core文件的工具，比如 *GNU Binutils Binary File Descriptor library (BFD)*, **GNU Debugger (gdb）**， *mdb* 等.

### 1.4 coredump的文件格式
类unix操作系统中使用efi格式保存coredump文件。
```
ld@ld-pc:~/Code/bin$ file core
core: ELF 64-bit LSB  core file x86-64, version 1 (SYSV), SVR4-style, from './coredump_test'

```

### 1.5 造成程序coredump的原因
1. 内存访问越界  
    - 由于使用错误的下标，导致数组访问越界
    - 搜索字符串时，依靠字符串结束符来判断字符串是否结束，但是字符串没有正常的使用结束符
    - 使用strcpy, strcat, sprintf, strcmp, strcasecmp等字符串操作函数，将目标字符串读/写爆。应该使用strncpy, strlcpy, strncat, strlcat, snprintf, strncmp, strncasecmp等函数防止读写越界。
2. 多线程程序使用了线程不安全的函数  
    应该使用可重入的函数.
3. 多线程读写的数据未加锁保护  
    对于会被多个线程同时访问的全局数据，应该注意加锁保护，否则很容易造成core dump.  
4. 非法指针  
    - 使用空指针
    - 随意使用指针转换。一个指向一段内存的指针，除非确定这段内存原先就分配为某种结构或类型，或者这种结构或类型的数组，否则不要将它转换为这种结构或类型 的指针，而应该将这段内存拷贝到一个这种结构或类型中，再访问这个结构或类型。这是因为如果这段内存的开始地址不是按照这种结构或类型对齐的，那么访问它 时就很容易因为bus error而core dump.  
5. 堆栈溢出  
    不要使用大的局部变量（因为局部变量都分配在栈上），这样容易造成堆栈溢出，破坏系统的栈和堆结构，导致出现莫名其妙的错误。

## 2. coredump文件生成及使用方法

### 2.1 一般内核都支持coredump
### 2.2 运行命令，此时允许coredump文件产生
使用`ulimit -c`命令设置core文件大小, 需要root权限修改.

```
ld@ld-pc:~/Code/bin$ ulimit -c
0

ld@ld-pc:~/Code/bin$ ulimit -c 1000
bash: ulimit: core file size: cannot modify limit: Operation not permitted

ld@ld-pc:~/Code/bin$ su
Password:
root@ld-pc:/home/ld/Code/bin# ulimit -c
0
root@ld-pc:/home/ld/Code/bin# ulimit -c 1000
root@ld-pc:/home/ld/Code/bin# ulimit -c
1000

root@ld-pc:/home/ld/Code/bin# ulimit -c unlimited
root@ld-pc:/home/ld/Code/bin# ulimit -c
unlimited

```

### 2.3 执行程序：
```
ld@ld-pc:~/Code/bin$ ./coredump_test
Segmentation fault (core dumped)
```
在异常退出时，会显示如下信息，注意括号里的内容
`Segmentation fault (core dumped)`
程序执行目录下将产生*`core文件`

## 3. 用gdb分析

```
ld@ld-pc:~/Code/bin$ gdb ./coredump_test core
GNU gdb (Ubuntu 7.7-0ubuntu3) 7.7
Copyright (C) 2014 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from ./coredump_test...done.
[New LWP 11645]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Core was generated by `./coredump_test'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x000000000040099f in dp () at /home/ld/Code/test/coredump_test.cpp:11
11	    p[23]='o';
warning: File "/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19-gdb.py" auto-loading has been declined by your `auto-load safe-path' set to "$debugdir:$datadir/auto-load".
To enable execution of this file add
	add-auto-load-safe-path /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19-gdb.py
line to your configuration file "/home/ld/.gdbinit".
To completely disable this security protection add
	set auto-load safe-path /
line to your configuration file "/home/ld/.gdbinit".
For more information about this security protection see the
"Auto-loading safe path" section in the GDB manual.  E.g., run from the shell:
	info "(gdb)Auto-loading safe path"

```

在进入gdb后, 用bt命令查看backtrace以检查发生程序运行到哪里, 来定位core dump的文件->行.
```
(gdb) bt
#0  0x000000000040099f in dp () at /home/ld/Code/test/coredump_test.cpp:11
#1  0x00000000004009ad in main () at /home/ld/Code/test/coredump_test.cpp:16
(gdb) where
#0  0x000000000040099f in dp () at /home/ld/Code/test/coredump_test.cpp:11
#1  0x00000000004009ad in main () at /home/ld/Code/test/coredump_test.cpp:16

```
